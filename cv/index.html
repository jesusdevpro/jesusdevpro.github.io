<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CV Studio Pro v5 - Database Sync</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='25' fill='%23007AFF'/><path d='M30 35h40M30 50h40M30 65h25' stroke='white' stroke-width='8' stroke-linecap='round'/></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #007AFF; --dark: #1C1C1E; --bg: #F2F2F7; --card: #FFFFFF; --error: #FF3B30; }
        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background-color: var(--bg); margin: 0; padding: 15px; color: var(--dark); display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 600px; padding-bottom: 120px; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05); }
        .card h3 { margin-top: 0; font-size: 1.1rem; color: var(--primary); border-bottom: 1px solid #F2F2F7; padding-bottom: 10px; }
        label { font-size: 0.8rem; color: #8E8E93; margin-left: 5px; }
        .required-star { color: var(--error); font-weight: bold; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #E5E5EA; border-radius: 10px; font-size: 16px; background: #F9F9FB; transition: border 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn-add { background: #F2F2F7; color: var(--primary); border: 2px dashed #D1D1D6; width: 100%; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .item-row { background: #F9F9FB; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin: 8px 0; border-left: 4px solid var(--primary); }
        .footer-actions { position: fixed; bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); width: calc(100% - 30px); max-width: 570px; z-index: 1000; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; transition: opacity 0.3s; }
        .btn-main:active { opacity: 0.7; }
        .btn-pdf { background: var(--dark); }
        .preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 1px solid #ddd; }
        #pdf-render { display: none; background: white; padding: 40px; color: black; }
        .pdf-section { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: bold; text-transform: uppercase; margin-top: 20px; padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="app-container">
    <div style="text-align: center; margin-bottom: 25px;">
        <h1 style="color: var(--primary); margin:0;">CV Studio Pro</h1>
        <p style="font-size: 0.8rem; color: #8E8E93;">Los campos con <span class="required-star">*</span> son obligatorios</p>
    </div>

    <div class="card">
        <h3>üë§ Datos Personales</h3>
        <label>Nombre Completo <span class="required-star">*</span></label>
        <input type="text" id="nombre" placeholder="Ej: Juan P√©rez">
        
        <label>C√©dula de Identidad <span class="required-star">*</span></label>
        <input type="text" id="cedula" placeholder="Ej: V-12.345.678">
        
        <label>Fecha de Nacimiento <span class="required-star">*</span></label>
        <input type="date" id="fecha_nacimiento">
        
        <label>Profesi√≥n o T√≠tulo Actual</label>
        <input type="text" id="cargo" placeholder="Ej: Ingeniero de Sistemas">
        
        <label>Tel√©fono de Contacto</label>
        <input type="text" id="telefono" placeholder="Ej: 0412-1234567">
        
        <label>Ciudad y Pa√≠s</label>
        <input type="text" id="ubicacion" placeholder="Ej: Caracas, Venezuela">
        
        <label>Correo Electr√≥nico</label>
        <input type="email" id="email" placeholder="nombre@ejemplo.com">
    </div>

    <div class="card">
        <h3>üìù Resumen Profesional <span class="required-star">*</span></h3>
        <textarea id="perfil" rows="3" placeholder="Describe brevemente qui√©n eres..."></textarea>
    </div>

    <div class="card">
        <h3>üíº Experiencia Laboral</h3>
        <div id="lista-exp"></div>
        <button class="btn-add" onclick="modalExp()">+ A√±adir Cargo</button>
    </div>

    <div class="card">
        <h3>üéì Educaci√≥n</h3>
        <div id="lista-edu"></div>
        <button class="btn-add" onclick="modalEdu()">+ A√±adir Educaci√≥n</button>
    </div>

    <div class="card">
        <h3>üìÇ Anexos y Documentos</h3>
        <input type="file" id="input-anexos" accept="image/*" multiple onchange="manejarAnexos(this)" style="display: none;">
        <button class="btn-add" onclick="document.getElementById('input-anexos').click()">üì∑ Subir T√≠tulos o Fotos</button>
        <div id="preview-anexos" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;"></div>
    </div>

    <div style="text-align: center; margin-bottom: 25px;">
        <p style="color: #8E8E93;">Desarrollado por: <b>jesus.rivero86@gmail.com</b></p>
    </div>

    <div class="footer-actions">
        <button class="btn-main" onclick="validarYGenerar('word')">Bajar Word</button>
        <button class="btn-main btn-pdf" onclick="validarYGenerar('pdf')">Bajar PDF</button>
    </div>
</div>

<div id="pdf-render"><div id="pdf-content"></div></div>

<script>
    let cv = { exp: [], edu: [], anexos: [] };
    const { Document, Packer, Paragraph, TextRun, AlignmentType, ImageRun, BorderStyle, PageBreak } = docx;

    // --- FUNCI√ìN DE REGISTRO EN GOOGLE SHEETS (SEGUNDO PLANO) ---
    async function registrarEnSheets() {
        const urlScript = "https://script.google.com/macros/s/AKfycbzftUWsR0IgJoQJ88fHN2YZJiZzMSPgHquDpiky009sZvAzMa4R8c_ls0lfpDsWHDSg/exec";
        
        const datos = {
            nombre: document.getElementById('nombre').value,
            cedula: document.getElementById('cedula').value,
            fecha_nacimiento: document.getElementById('fecha_nacimiento').value,
            cargo: document.getElementById('cargo').value,
            telefono: document.getElementById('telefono').value,
            email: document.getElementById('email').value
        };

        try {
            fetch(urlScript, {
                method: 'POST',
                mode: 'no-cors', 
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            console.log("Datos enviados a la base de datos.");
        } catch (e) {
            console.error("Error de sincronizaci√≥n", e);
        }
    }

    // --- VALIDACI√ìN Y DISPARO ---
    function validarYGenerar(tipo) {
        const campos = [
            { id: 'nombre', nombre: 'Nombre Completo' },
            { id: 'cedula', nombre: 'C√©dula de Identidad' },
            { id: 'fecha_nacimiento', nombre: 'Fecha de Nacimiento' },
            { id: 'perfil', nombre: 'Resumen Profesional' }
        ];

        let faltantes = [];
        campos.forEach(campo => {
            const el = document.getElementById(campo.id);
            if (!el.value.trim()) {
                faltantes.push(campo.nombre);
                el.style.borderColor = "var(--error)";
            } else {
                el.style.borderColor = "#E5E5EA";
            }
        });

        if (faltantes.length > 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Campos Obligatorios',
                html: `Faltan datos esenciales:<br><b>${faltantes.join(', ')}</b>`,
                confirmButtonColor: 'var(--primary)'
            });
            return;
        }

        // Ejecutar registro silencioso
        registrarEnSheets();

        // Ejecutar generaci√≥n de archivo
        if (tipo === 'word') generarWord();
        else generarPDF();
    }

    // --- L√ìGICA DE MODALES Y UI (ID√âNTICA A LA TUYA) ---
    const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    const getYears = () => {
        let years = "";
        for(let i = new Date().getFullYear(); i >= 1970; i--) years += `<option value="${i}">${i}</option>`;
        return years;
    };

    async function modalExp() {
        const { value: v } = await Swal.fire({
            title: 'Detalles del Cargo',
            html: `
                <input id="sw-emp" class="swal2-input" placeholder="Empresa">
                <input id="sw-car" class="swal2-input" placeholder="Cargo">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:10px;">
                    <select id="sw-m1" class="swal2-input">${months.map(m=>`<option>${m}</option>`)}</select>
                    <select id="sw-a1" class="swal2-input">${getYears()}</select>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    <select id="sw-m2" class="swal2-input"><option value="Presente">Presente</option>${months.map(m=>`<option>${m}</option>`)}</select>
                    <select id="sw-a2" class="swal2-input"><option value="">-</option>${getYears()}</select>
                </div>
                <textarea id="sw-tar" class="swal2-textarea" placeholder="Descripci√≥n..."></textarea>
            `,
            preConfirm: () => {
                const fin = document.getElementById('sw-m2').value === 'Presente' ? 'Actualidad' : `${document.getElementById('sw-m2').value} ${document.getElementById('sw-a2').value}`;
                return { emp: document.getElementById('sw-emp').value, car: document.getElementById('sw-car').value, periodo: `${document.getElementById('sw-m1').value} ${document.getElementById('sw-a1').value} ‚Äì ${fin}`, tar: document.getElementById('sw-tar').value };
            }
        });
        if (v && v.emp) { cv.exp.push(v); updateUI('lista-exp', cv.exp, 'car'); }
    }

    async function modalEdu() {
        const { value: v } = await Swal.fire({
            title: 'Educaci√≥n',
            html: `<input id="sw-tit" class="swal2-input" placeholder="T√≠tulo"><input id="sw-uni" class="swal2-input" placeholder="Instituci√≥n"><select id="sw-ano" class="swal2-input">${getYears()}</select>`,
            preConfirm: () => ({ tit: document.getElementById('sw-tit').value, uni: document.getElementById('sw-uni').value, fec: document.getElementById('sw-ano').value })
        });
        if (v && v.tit) { cv.edu.push(v); updateUI('lista-edu', cv.edu, 'tit'); }
    }

    function manejarAnexos(input) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => { cv.anexos.push(e.target.result); renderAnexos(); };
            reader.readAsDataURL(file);
        });
    }

    function renderAnexos() {
        document.getElementById('preview-anexos').innerHTML = cv.anexos.map((src, i) => `
            <div style="position: relative;">
                <img src="${src}" class="preview-img">
                <span onclick="cv.anexos.splice(${i},1); renderAnexos()" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:20px; height:20px; font-size:12px; text-align:center; cursor:pointer;">√ó</span>
            </div>
        `).join('');
    }

    function updateUI(id, arr, key) {
        document.getElementById(id).innerHTML = arr.map(i => `<div class="item-row"><span>${i[key]}</span></div>`).join('');
    }

    // --- EXPORTAR WORD ---
    async function generarWord() {
        Swal.fire({ title: 'Generando Word...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const children = [
            new Paragraph({ children: [new TextRun({ text: document.getElementById('nombre').value.toUpperCase(), bold: true, size: 44 })], alignment: AlignmentType.CENTER }),
            new Paragraph({ children: [new TextRun({ text: `C.I: ${document.getElementById('cedula').value} | F. Nac: ${document.getElementById('fecha_nacimiento').value}`, size: 18, color: "444444" })], alignment: AlignmentType.CENTER }),
            new Paragraph({ children: [new TextRun({ text: (document.getElementById('cargo').value || "CURRICULUM VITAE").toUpperCase(), size: 24, color: "666666" })], alignment: AlignmentType.CENTER, spacing: { after: 200 } }),
            new Paragraph({ children: [new TextRun({ text: `${document.getElementById('telefono').value} | ${document.getElementById('email').value} | ${document.getElementById('ubicacion').value}`, size: 18 })], alignment: AlignmentType.CENTER, spacing: { after: 400 } }),
            
            ...createHeader("PERFIL"),
            new Paragraph({ children: [new TextRun({ text: document.getElementById('perfil').value, size: 21 })], spacing: { after: 200 } }),

            ...createHeader("EXPERIENCIA"),
            ...cv.exp.flatMap(e => [
                new Paragraph({ children: [new TextRun({ text: `${e.emp.toUpperCase()} | ${e.car}`, bold: true, size: 22 })], spacing: { before: 200 } }),
                new Paragraph({ children: [new TextRun({ text: e.periodo, italic: true, size: 18 })] }),
                new Paragraph({ children: [new TextRun({ text: e.tar, size: 20 })], spacing: { after: 100 } })
            ]),

            ...createHeader("EDUCACI√ìN"),
            ...cv.edu.flatMap(e => [
                new Paragraph({ children: [new TextRun({ text: `${e.tit} ‚Äî ${e.uni} (${e.fec})`, bold: true, size: 21 })], spacing: { after: 150 } })
            ])
        ];

        for (const b64 of cv.anexos) {
            children.push(new Paragraph({ children: [new PageBreak()] }));
            const r = await fetch(b64);
            const b = await r.blob();
            children.push(new Paragraph({ children: [new ImageRun({ data: b, transformation: { width: 550, height: 750 } })], alignment: AlignmentType.CENTER }));
        }

        const doc = new Document({ sections: [{ children }] });
        Packer.toBlob(doc).then(blob => { saveAs(blob, "Curriculum_Profesional.docx"); Swal.fire('¬°√âxito!', 'Archivo Word listo', 'success'); });
    }

    function createHeader(t) {
        return [new Paragraph({ children: [new TextRun({ text: t, bold: true, size: 24, color: "007AFF" })], border: { bottom: { color: "007AFF", style: BorderStyle.SINGLE, size: 6 } }, spacing: { before: 400, after: 150 } })];
    }

    // --- EXPORTAR PDF ---
    function generarPDF() {
        const content = document.getElementById('pdf-content');
        content.innerHTML = `
            <div style="text-align:center">
                <h1 style="margin:0; font-size:28px;">${document.getElementById('nombre').value.toUpperCase()}</h1>
                <p style="margin:5px 0; font-size:14px; color:#555">C.I: ${document.getElementById('cedula').value} | F. Nac: ${document.getElementById('fecha_nacimiento').value}</p>
                <p style="color:#007AFF; font-size:18px; font-weight:bold">${(document.getElementById('cargo').value || "CURRICULUM VITAE").toUpperCase()}</p>
                <p style="font-size:12px;">${document.getElementById('telefono').value} | ${document.getElementById('email').value} | ${document.getElementById('ubicacion').value}</p>
            </div>
            <div class="pdf-section">Perfil</div><p style="font-size:13px;">${document.getElementById('perfil').value}</p>
            <div class="pdf-section">Experiencia</div>
            ${cv.exp.map(e => `<div style="margin-top:10px"><div style="font-weight:bold">${e.emp} | ${e.car}</div><div style="font-size:11px; font-style:italic">${e.periodo}</div><div style="font-size:12px">${e.tar}</div></div>`).join('')}
            <div class="pdf-section">Educaci√≥n</div>
            ${cv.edu.map(e => `<div style="margin-top:5px; font-weight:bold">${e.tit} ‚Äî ${e.uni} (${e.fec})</div>`).join('')}
            ${cv.anexos.map(img => `<div style="page-break-before: always; text-align:center"><img src="${img}" style="max-width:100%; max-height:900px"></div>`).join('')}
        `;
        document.getElementById('pdf-render').style.display = "block";
        html2pdf().from(content).set({ margin: 10, filename: 'Curriculum_Profesional.pdf', html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } }).save().then(() => {
            document.getElementById('pdf-render').style.display = "none";
            Swal.fire('¬°√âxito!', 'Archivo PDF listo', 'success');
        });
    }
</script>

</body>
</html>
